(()=>{"use strict";var e=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))},t=function(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},n={},r="",o="";function s(e){var t=e.accumulatedTime||0;return e.time-t}function i(r,s,i){return e(this,void 0,void 0,(function(){var c=this;return t(this,(function(u){return n[s]&&clearTimeout(n[s]),chrome.storage.local.get("sites",(function(e){var t=e.sites||{};(t[r]||{}).startTime=Date.now(),chrome.storage.local.set({sites:t})})),n[s]=setTimeout((function(){return e(c,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,a(r,o,s)];case 1:return e.sent(),[2]}}))}))}),1e3*i),[2]}))}))}function c(e){var t=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return"^".concat(t,".*$")}function a(r,o,s){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return n[s]?[4,b(r,!0)]:[3,2];case 1:e.sent(),u(r,o,s),e.label=2;case 2:return[2]}}))}))}function u(e,t,n){var r={url:e,message:t};chrome.storage.local.set({blockedSite:r},(function(){chrome.tabs.update(n,{url:chrome.runtime.getURL("blocked.html")})}))}function l(e,t){var n=new Date(e);return n.getFullYear()===t.getFullYear()&&n.getMonth()===t.getMonth()&&n.getDate()===t.getDate()}function f(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,new Promise((function(e){chrome.storage.local.get("sites",(function(t){var r=t.sites||{},o=Object.keys(r);if(0!==o.length){for(var s=0,i=o;s<i.length;s++){var a=i[s];if(a){var u=r[a];if(new RegExp(u.pattern||c(a)).test(n))return void e(a)}}e(null)}else e(null)}))}))]}))}))}function d(e,t){r=e,o=t}function h(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,new Promise((function(e,t){chrome.storage.local.get("sites",(function(t){var r=t.sites||{};r[n]?(r[n].totalVisits=(r[n].totalVisits||0)+1,chrome.storage.local.set({sites:r},(function(){e()}))):e()}))}))]}))}))}function v(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,new Promise((function(e,t){chrome.storage.local.get("sites",(function(t){var r=t.sites||{};r[n]?(r[n].totalVisitsWhenBlocked=(r[n].totalVisitsWhenBlocked||0)+1,chrome.storage.local.set({sites:r},(function(){e()}))):e()}))}))]}))}))}function b(n,r){return e(this,void 0,void 0,(function(){var e,o;return t(this,(function(t){switch(t.label){case 0:return console.log("Updating blocked status for:",n),[4,("sites",new Promise((function(e){chrome.storage.local.get("sites",(function(t){e(t)}))})))];case 1:return e=t.sent(),(o=e.sites||{})[n]?(o[n].blocked=r,[4,m({sites:o})]):[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))}function m(e){return new Promise((function(t){chrome.storage.local.set(e,(function(){t()}))}))}function g(o){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return n[o]?(d("",""),clearTimeout(n[o]),[4,new Promise((function(e,t){chrome.storage.local.get("sites",(function(n){if(r&&n.sites&&n.sites[r]){var o=n.sites[r],s=Date.now(),i=o.startTime?(s-o.startTime)/1e3:0;o.accumulatedTime=(o.accumulatedTime||0)+i,chrome.storage.local.set({sites:n.sites},(function(){e()}))}else t(new Error("Site ".concat(r," not found in storage")))}))}))]):[3,2];case 1:e.sent(),delete n[o],e.label=2;case 2:return[2]}}))}))}chrome.webNavigation.onBeforeNavigate.addListener((function(n){return e(void 0,void 0,void 0,(function(){var r;return t(this,(function(s){switch(s.label){case 0:return 0===n.frameId&&n.url?[4,f(n.url)]:[3,2];case 1:(r=s.sent())&&chrome.storage.local.get("sites",(function(s){return e(void 0,void 0,void 0,(function(){var e,i,a;return t(this,(function(t){switch(t.label){case 0:return e=s.sites[r],d(r,e.message),new RegExp(e.pattern||c(r)),i=new Date,a=e.startTime||0,[4,h(r)];case 1:return t.sent(),l(a,i)||!e.blocked?[3,3]:[4,b(r,!1)];case 2:return t.sent(),[3,5];case 3:return e.blocked?[4,v(r)]:[3,5];case 4:t.sent(),u(r,o,n.tabId),t.label=5;case 5:return[2]}}))}))})),s.label=2;case 2:return[2]}}))}))}),{url:[{schemes:["http","https"]}]}),chrome.webNavigation.onCompleted.addListener((function(n){return e(void 0,void 0,void 0,(function(){var r;return t(this,(function(a){switch(a.label){case 0:return 0===n.frameId&&n.url?[4,f(n.url)]:[3,2];case 1:(r=a.sent())&&chrome.storage.local.get("sites",(function(a){return e(void 0,void 0,void 0,(function(){var e,f,m,g;return t(this,(function(t){switch(t.label){case 0:return e=a.sites[r],d(r,e.message),new RegExp(e.pattern||c(r)),f=new Date,m=e.startTime||0,[4,h(r)];case 1:return t.sent(),l(m,f)||!e.blocked?[3,4]:[4,b(r,!1)];case 2:return t.sent(),[4,i(r,n.tabId,s(e))];case 3:return t.sent(),[3,10];case 4:return e.blocked?[4,v(r)]:[3,6];case 5:return t.sent(),u(r,o,n.tabId),[3,10];case 6:return(g=s(e))<=0?[4,b(r,!0)]:[3,8];case 7:return t.sent(),u(r,o,n.tabId),[3,10];case 8:return[4,i(r,n.tabId,g)];case 9:t.sent(),t.label=10;case 10:return[2]}}))}))})),a.label=2;case 2:return[2]}}))}))}),{url:[{schemes:["http","https"]}]}),chrome.tabs.onActivated.addListener((function(n){return e(void 0,void 0,void 0,(function(){return t(this,(function(a){return n.tabId&&chrome.tabs.get(n.tabId,(function(a){return e(void 0,void 0,void 0,(function(){var d;return t(this,(function(m){switch(m.label){case 0:return a&&a.url?[4,f(a.url)]:[3,4];case 1:return(d=m.sent())?(chrome.storage.local.get("sites",(function(a){return e(void 0,void 0,void 0,(function(){var e,f,m;return t(this,(function(t){switch(t.label){case 0:return e=a.sites[d],r=d,o=e.message,new RegExp(e.pattern||c(d)),f=new Date,m=e.startTime||0,[4,h(d)];case 1:return t.sent(),l(m,f)||!e.blocked?[3,4]:[4,b(d,!1)];case 2:return t.sent(),[4,i(d,n.tabId,s(e))];case 3:return t.sent(),[3,8];case 4:return e.blocked?[4,v(d)]:[3,6];case 5:return t.sent(),u(d,o,n.tabId),[3,8];case 6:return[4,i(d,n.tabId,s(e))];case 7:t.sent(),t.label=8;case 8:return[2]}}))}))})),[3,4]):[3,2];case 2:return[4,g(n.tabId)];case 3:m.sent(),m.label=4;case 4:return[2]}}))}))})),[2]}))}))})),chrome.tabs.onRemoved.addListener((function(n){return e(void 0,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,g(n)];case 1:return e.sent(),[2]}}))}))}))})();