(()=>{"use strict";var e=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))},t=function(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,o=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){s=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(6===c[0]&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},n={},o="",r=null,i="";function s(e){var t=e.accumulatedTime||0;return e.time-t}function c(o,r,s){return e(this,void 0,void 0,(function(){var c=this;return t(this,(function(a){return console.log("Starting timer for:",o),n[r]&&clearTimeout(n[r]),chrome.storage.local.get("sites",(function(e){var t=e.sites||{};(t[o]||{}).startTime=Date.now(),chrome.storage.local.set({sites:t})})),n[r]=setTimeout((function(){return e(c,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,l(o,i,r)];case 1:return e.sent(),[2]}}))}))}),1e3*s),[2]}))}))}function a(e){var t=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return"^".concat(t,".*$")}function l(o,r,i){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return console.log("Time limit reached for:",o),n[i]?[4,h(o,!0)]:[3,2];case 1:e.sent(),u(o,r,i),e.label=2;case 2:return[2]}}))}))}function u(e,t,n){console.log("Redirecting to blocked page for:",e);var o={url:e,message:t};chrome.storage.local.set({blockedSite:o},(function(){chrome.tabs.update(n,{url:chrome.runtime.getURL("blocked.html")})}))}function d(e){console.log("Updating total visits for:",e),chrome.storage.local.get("sites",(function(t){var n=t.sites||{};n[e]&&(n[e].totalVisits=(n[e].totalVisits||0)+1,chrome.storage.local.set({sites:n}))}))}function f(e,t){var n=new Date(e);return n.getFullYear()===t.getFullYear()&&n.getMonth()===t.getMonth()&&n.getDate()===t.getDate()}function g(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,new Promise((function(e){chrome.storage.local.get("sites",(function(t){var o=t.sites||{},r=Object.keys(o);if(0===r.length)return console.log("No sites found in storage."),void e(null);for(var i=0,s=r;i<s.length;i++){var c=s[i];if(c){var l=o[c];if(new RegExp(l.pattern||a(c)).test(n))return void e(c)}}e(null)}))}))]}))}))}function h(n,o){return e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return console.log("Updating blocked status for:",n),[4,("sites",new Promise((function(e){chrome.storage.local.get("sites",(function(t){e(t)}))})))];case 1:return e=t.sent(),(r=e.sites||{})[n]?(r[n].blocked=o,[4,v({sites:r})]):[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))}function v(e){return new Promise((function(t){chrome.storage.local.set(e,(function(){t()}))}))}function b(e,t){o=e,i=t}function m(e){n[e]&&(b("",""),r=null,clearTimeout(n[e]),console.log("UPDATE ACCUMULATED TIME"),chrome.storage.local.get("sites",(function(e){if(o&&e.sites[o]){var t=e.sites[o],n=Date.now(),r=t.startTime?(n-t.startTime)/1e3:0;console.log("ELAPSED TIMES:",r),t.accumulatedTime=(t.accumulatedTime||0)+r,chrome.storage.local.set({sites:e.sites})}})),delete n[e])}chrome.webNavigation.onBeforeNavigate.addListener((function(n){return e(void 0,void 0,void 0,(function(){var o;return t(this,(function(s){switch(s.label){case 0:return console.log("Inside onBeforeNavigate"),0===n.frameId&&n.url?(console.log("Navigating to:",n.url),[4,g(n.url)]):[3,2];case 1:(o=s.sent())&&(console.log("Matched site:",o),chrome.storage.local.get("sites",(function(s){return e(void 0,void 0,void 0,(function(){var e,c;return t(this,(function(t){switch(t.label){case 0:return e=s.sites[o],b(o,e.message),r=new RegExp(e.pattern||a(o)),c=new Date,f(e.startTime||0,c)||!e.blocked?[3,2]:(console.log("Not the same date, unblocking site"),[4,h(o,!1)]);case 1:return t.sent(),[3,3];case 2:e.blocked&&(console.log("Site is blocked, redirecting to blocked page"),d(o),u(o,i,n.tabId)),t.label=3;case 3:return[2]}}))}))}))),s.label=2;case 2:return[2]}}))}))}),{url:[{schemes:["http","https"]}]}),chrome.webNavigation.onCompleted.addListener((function(n){return e(void 0,void 0,void 0,(function(){var o;return t(this,(function(l){switch(l.label){case 0:return console.log("Inside onCompleted"),0===n.frameId&&n.url?(console.log("Completed navigation to:",n.url),[4,g(n.url)]):[3,2];case 1:(o=l.sent())&&(console.log("Matched site:",o),chrome.storage.local.get("sites",(function(l){return e(void 0,void 0,void 0,(function(){var e,g,v;return t(this,(function(t){switch(t.label){case 0:return e=l.sites[o],b(o,e.message),r=new RegExp(e.pattern||a(o)),g=new Date,f(e.startTime||0,g)||!e.blocked?[3,3]:(console.log("Not the same date, unblocking site and starting timer"),[4,h(o,!1)]);case 1:return t.sent(),[4,c(o,n.tabId,s(e))];case 2:return t.sent(),[3,8];case 3:return e.blocked?(console.log("Site is blocked, redirecting to blocked page"),d(o),u(o,i,n.tabId),[3,8]):[3,4];case 4:return console.log("Site is not blocked, starting timer"),(v=s(e))<=0?(console.log("Remaining time <= 0, blocking site"),[4,h(o,!0)]):[3,6];case 5:return t.sent(),u(o,i,n.tabId),[3,8];case 6:return[4,c(o,n.tabId,v)];case 7:t.sent(),t.label=8;case 8:return[2]}}))}))}))),l.label=2;case 2:return[2]}}))}))}),{url:[{schemes:["http","https"]}]}),chrome.tabs.onActivated.addListener((function(n){return e(void 0,void 0,void 0,(function(){return t(this,(function(l){return console.log("Inside onActivated"),n.tabId&&chrome.tabs.get(n.tabId,(function(l){return e(void 0,void 0,void 0,(function(){var d;return t(this,(function(v){switch(v.label){case 0:return l&&l.url?[4,g(l.url)]:[3,2];case 1:(d=v.sent())?chrome.storage.local.get("sites",(function(g){return e(void 0,void 0,void 0,(function(){var e,v,b;return t(this,(function(t){switch(t.label){case 0:return e=g.sites[d],o=d,i=e.message,r=new RegExp(e.pattern||a(d)),console.log("Activated URL:",l.url),console.log("Activated pattern:",r),v=new Date,b=e.startTime||0,console.log("Start time:",b),f(b,v)||!e.blocked?[3,3]:(console.log("Not the same date, unblocking site and starting timer"),[4,h(d,!1)]);case 1:return t.sent(),[4,c(d,n.tabId,s(e))];case 2:return t.sent(),[3,6];case 3:return e.blocked?(u(d,i,n.tabId),[3,6]):[3,4];case 4:return[4,c(d,n.tabId,s(e))];case 5:t.sent(),t.label=6;case 6:return[2]}}))}))})):m(n.tabId),v.label=2;case 2:return[2]}}))}))})),[2]}))}))})),chrome.tabs.onRemoved.addListener((function(e){console.log("Inside onRemoved"),m(e)}))})();